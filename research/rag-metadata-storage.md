# é«˜æ ¡æ•°å­—èµ„äº§ç®¡ç†ç³»ç»Ÿ - æ–‡ä»¶æº¯æºä¸å…ƒæ•°æ®å­˜å‚¨æ–¹æ¡ˆ

> è¡¥å……ï¼šè¿”å›åŸæ–‡ä»¶ä¿¡æ¯ + å¯¹è±¡å­˜å‚¨å…ƒæ•°æ®

---

## ğŸ¯ æ ¸å¿ƒéœ€æ±‚

1. **æ£€ç´¢ç­”æ¡ˆæ—¶èƒ½è¿½æº¯åˆ°åŸæ–‡ä»¶**
   - æ˜¾ç¤ºæ¥æºæ–‡ä»¶å
   - æ˜¾ç¤ºå…·ä½“é¡µç /ç« èŠ‚
   - æ”¯æŒç‚¹å‡»æŸ¥çœ‹åŸæ–‡

2. **å…ƒæ•°æ®ç®¡ç†**
   - æ–‡ä»¶ç±»å‹ã€å¤§å°ã€ä¸Šä¼ æ—¶é—´
   - ä½œè€…ã€åˆ†ç±»ã€æ ‡ç­¾
   - æ–‡ä»¶å…³è”å…³ç³»

3. **åŸæ–‡ä»¶å­˜å‚¨**
   - ä¿ç•™åŸå§‹æ–‡ä»¶
   - æ”¯æŒåœ¨çº¿é¢„è§ˆ
   - æ”¯æŒä¸‹è½½

---

## ğŸ—ï¸ å®Œæ•´æ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     ç”¨æˆ·ç•Œé¢å±‚                                â”‚
â”‚  ä¸Šä¼ æ–‡æ¡£ | æœç´¢é—®ç­” | æŸ¥çœ‹åŸæ–‡ | ä¸‹è½½æ–‡ä»¶                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     åº”ç”¨æœåŠ¡å±‚                                â”‚
â”‚  æ–‡æ¡£å¤„ç†æœåŠ¡ | RAGæ£€ç´¢æœåŠ¡ | æ–‡ä»¶é¢„è§ˆæœåŠ¡                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â†“                     â†“                     â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   å‘é‡æ•°æ®åº“    â”‚    â”‚   å…ƒæ•°æ®åº“     â”‚    â”‚   å¯¹è±¡å­˜å‚¨     â”‚
â”‚   (Milvus)    â”‚    â”‚  (PostgreSQL) â”‚    â”‚   (MinIO)     â”‚
â”‚               â”‚    â”‚               â”‚    â”‚               â”‚
â”‚ - æ–‡æœ¬å‘é‡     â”‚    â”‚ - æ–‡ä»¶ä¿¡æ¯     â”‚    â”‚ - åŸå§‹æ–‡ä»¶     â”‚
â”‚ - chunk_id    â”‚    â”‚ - åˆ†å—æ˜ å°„     â”‚    â”‚ - é¢„è§ˆå›¾      â”‚
â”‚ - doc_id      â”‚    â”‚ - ç”¨æˆ·æƒé™     â”‚    â”‚ - ç¼©ç•¥å›¾      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ“¦ å¯¹è±¡å­˜å‚¨æ–¹æ¡ˆ

### æ¨èï¼šMinIO (è‡ªå»º) æˆ– é˜¿é‡Œäº‘ OSS

| æ–¹æ¡ˆ | ç‰¹ç‚¹ | é€‚ç”¨åœºæ™¯ |
|------|------|----------|
| **MinIO** | å¼€æºã€S3å…¼å®¹ã€å¯è‡ªå»º | æ ¡å†…éƒ¨ç½²ã€æ•°æ®å®‰å…¨è¦æ±‚é«˜ |
| **é˜¿é‡Œäº‘ OSS** | æ‰˜ç®¡ã€ç¨³å®šã€ä¾¿å®œ | å¿«é€Ÿä¸Šçº¿ã€è¿ç»´ç®€å• |
| **è…¾è®¯äº‘ COS** | æ‰˜ç®¡ã€å›½å†…è®¿é—®å¿« | å¤‡é€‰ |

### MinIO éƒ¨ç½²
```bash
# Docker ä¸€é”®éƒ¨ç½²
docker run -d \
  -p 9000:9000 \
  -p 9001:9001 \
  -v /data/minio:/data \
  -e "MINIO_ROOT_USER=admin" \
  -e "MINIO_ROOT_PASSWORD=password" \
  minio/minio server /data --console-address ":9001"
```

---

## ğŸ—„ï¸ å…ƒæ•°æ®è¡¨è®¾è®¡

### 1. æ–‡æ¡£è¡¨ (documents)
```sql
CREATE TABLE documents (
    id UUID PRIMARY KEY,
    filename VARCHAR(255) NOT NULL,
    file_type VARCHAR(50),           -- pdf, docx, pptx
    file_size BIGINT,
    storage_path VARCHAR(500),       -- MinIO è·¯å¾„
    upload_time TIMESTAMP,
    uploader_id UUID,
    
    -- ä¸šåŠ¡å…ƒæ•°æ®
    title VARCHAR(255),
    author VARCHAR(100),
    category VARCHAR(100),           -- åˆ›ä¸šè®¡åˆ’ä¹¦ã€æ•™å­¦æ¡ˆä¾‹ã€æ¯”èµ›ç­–åˆ’
    tags TEXT[],                     -- æ ‡ç­¾æ•°ç»„
    description TEXT,
    
    -- å¤„ç†çŠ¶æ€
    process_status VARCHAR(50),      -- pending, processing, completed, failed
    chunk_count INT,
    
    created_at TIMESTAMP DEFAULT NOW(),
    updated_at TIMESTAMP DEFAULT NOW()
);
```

### 2. æ–‡æ¡£åˆ†å—è¡¨ (document_chunks)
```sql
CREATE TABLE document_chunks (
    id UUID PRIMARY KEY,
    document_id UUID REFERENCES documents(id),
    chunk_index INT,                 -- åˆ†å—åºå·
    content TEXT,                    -- åˆ†å—æ–‡æœ¬
    
    -- å®šä½ä¿¡æ¯ï¼ˆç”¨äºæº¯æºï¼‰
    page_number INT,                 -- é¡µç 
    section_title VARCHAR(255),      -- ç« èŠ‚æ ‡é¢˜
    start_char INT,                  -- èµ·å§‹å­—ç¬¦ä½ç½®
    end_char INT,                    -- ç»“æŸå­—ç¬¦ä½ç½®
    
    -- å‘é‡ IDï¼ˆå…³è” Milvusï¼‰
    vector_id VARCHAR(100),
    
    created_at TIMESTAMP DEFAULT NOW()
);
```

### 3. åˆ†ç±»è¡¨ (categories)
```sql
CREATE TABLE categories (
    id UUID PRIMARY KEY,
    name VARCHAR(100),
    parent_id UUID,                  -- æ”¯æŒå±‚çº§åˆ†ç±»
    description TEXT
);

-- é¢„è®¾åˆ†ç±»
INSERT INTO categories (id, name) VALUES
    (gen_random_uuid(), 'åˆ›ä¸šè®¡åˆ’ä¹¦'),
    (gen_random_uuid(), 'ä¼˜ç§€æ•™å¸ˆæ¡ˆä¾‹'),
    (gen_random_uuid(), 'æ¯”èµ›ç­–åˆ’'),
    (gen_random_uuid(), 'æ•™å­¦è¯¾ä»¶'),
    (gen_random_uuid(), 'å­¦æœ¯è®ºæ–‡');
```

---

## ğŸ” æ£€ç´¢ç»“æœè¿”å›æ ¼å¼

### API å“åº”ç¤ºä¾‹
```json
{
    "answer": "æ ¹æ®ã€Š2024å¹´äº’è”ç½‘+åˆ›ä¸šè®¡åˆ’ä¹¦ã€‹ä¸­çš„åˆ†æï¼Œå¸‚åœºè§„æ¨¡é¢„è®¡è¾¾åˆ°500äº¿...",
    "sources": [
        {
            "document_id": "uuid-1234",
            "filename": "äº’è”ç½‘+åˆ›ä¸šè®¡åˆ’ä¹¦.pdf",
            "title": "2024å¹´äº’è”ç½‘+åˆ›ä¸šè®¡åˆ’ä¹¦",
            "category": "åˆ›ä¸šè®¡åˆ’ä¹¦",
            "author": "å¼ ä¸‰",
            "page_number": 15,
            "section": "ç¬¬ä¸‰ç«  å¸‚åœºåˆ†æ",
            "relevance_score": 0.92,
            "snippet": "...å¸‚åœºè§„æ¨¡é¢„è®¡è¾¾åˆ°500äº¿å…ƒï¼Œå¹´å¢é•¿ç‡ä¿æŒåœ¨25%ä»¥ä¸Š...",
            "preview_url": "/api/documents/uuid-1234/preview?page=15",
            "download_url": "/api/documents/uuid-1234/download"
        },
        {
            "document_id": "uuid-5678",
            "filename": "å¸‚åœºè°ƒç ”æŠ¥å‘Š.docx",
            ...
        }
    ],
    "total_sources": 3
}
```

---

## ğŸ“„ æ–‡ä»¶é¢„è§ˆæ–¹æ¡ˆ

### æ–¹æ¡ˆå¯¹æ¯”

| æ–¹æ¡ˆ | ä¼˜ç‚¹ | ç¼ºç‚¹ |
|------|------|------|
| **pdf.js** | å¼€æºã€å‰ç«¯æ¸²æŸ“ | åªæ”¯æŒ PDF |
| **Office Online** | å¾®è½¯å®˜æ–¹ã€æ•ˆæœå¥½ | éœ€è¦å…¬ç½‘è®¿é—® |
| **OnlyOffice** | å¼€æºã€æ”¯æŒå¤šæ ¼å¼ | éœ€è¦éƒ¨ç½² |
| **LibreOffice + unoconv** | è½¬æ¢ä¸º PDF | éœ€è¦å®‰è£… |

### æ¨èï¼šOnlyOffice Document Server
```bash
# Docker éƒ¨ç½²
docker run -d \
  -p 8080:80 \
  --name onlyoffice \
  onlyoffice/documentserver
```

---

## ğŸ’» ä»£ç ç¤ºä¾‹

### ä¸Šä¼ å¹¶å¤„ç†æ–‡æ¡£
```python
from minio import Minio
from llama_index.core import Document
from sqlalchemy.orm import Session

async def upload_document(file, db: Session, minio_client: Minio):
    # 1. ä¸Šä¼ åˆ° MinIO
    file_path = f"documents/{uuid4()}/{file.filename}"
    minio_client.put_object(
        bucket_name="assets",
        object_name=file_path,
        data=file.file,
        length=file.size
    )
    
    # 2. ä¿å­˜å…ƒæ•°æ®åˆ° PostgreSQL
    doc = Document(
        filename=file.filename,
        file_type=file.content_type,
        file_size=file.size,
        storage_path=file_path,
        process_status="pending"
    )
    db.add(doc)
    db.commit()
    
    # 3. å¼‚æ­¥å¤„ç†æ–‡æ¡£ï¼ˆCelery ä»»åŠ¡ï¼‰
    process_document.delay(doc.id)
    
    return doc
```

### æ£€ç´¢å¹¶è¿”å›æ¥æº
```python
from llama_index.core import VectorStoreIndex

async def search_with_sources(query: str, db: Session):
    # 1. å‘é‡æ£€ç´¢
    results = vector_index.query(query, top_k=5)
    
    # 2. è·å–æ¥æºä¿¡æ¯
    sources = []
    for node in results.source_nodes:
        chunk = db.query(DocumentChunk).filter_by(
            vector_id=node.id_
        ).first()
        
        doc = db.query(Document).filter_by(
            id=chunk.document_id
        ).first()
        
        sources.append({
            "document_id": str(doc.id),
            "filename": doc.filename,
            "title": doc.title,
            "category": doc.category,
            "page_number": chunk.page_number,
            "section": chunk.section_title,
            "snippet": chunk.content[:200],
            "preview_url": f"/api/documents/{doc.id}/preview?page={chunk.page_number}",
            "download_url": f"/api/documents/{doc.id}/download"
        })
    
    return {
        "answer": results.response,
        "sources": sources
    }
```

---

## ğŸš€ æŠ€æœ¯æ ˆæ€»ç»“

| ç»„ä»¶ | æ¨èæ–¹æ¡ˆ |
|------|----------|
| **æ¡†æ¶** | FastAPI + LlamaIndex |
| **å‘é‡åº“** | Milvus |
| **å…ƒæ•°æ®åº“** | PostgreSQL |
| **å¯¹è±¡å­˜å‚¨** | MinIO (è‡ªå»º) æˆ– é˜¿é‡Œäº‘ OSS |
| **æ–‡ä»¶é¢„è§ˆ** | OnlyOffice / pdf.js |
| **ä»»åŠ¡é˜Ÿåˆ—** | Celery + Redis |
| **å‰ç«¯** | Vue3 / React |

---

## ğŸ“‹ ä¸‹ä¸€æ­¥

1. [ ] ç¡®å®šéƒ¨ç½²ç¯å¢ƒï¼ˆäº‘æœåŠ¡å™¨ / æ ¡å†…æœåŠ¡å™¨ï¼‰
2. [ ] é€‰æ‹©å¯¹è±¡å­˜å‚¨æ–¹æ¡ˆï¼ˆMinIO / OSSï¼‰
3. [ ] è®¾è®¡è¯¦ç»†çš„ API æ¥å£
4. [ ] å¼€å§‹åŸå‹å¼€å‘

---

*ç ”ç©¶æ•´ç†ï¼špowerA / Voltex*
*æ—¥æœŸï¼š2026-02-04*
